datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

enum DRIVERSTATE {
  DRIVING
  PARKED
  RACING
  NOT_RACING
}

enum SpeedBucket {
  SLOW
  MEDIUM
  FAST
}

enum RaceState {
  REQUESTED
  LOCKED
  RACING
  FINISHED
  ABORTED
}

enum ReadyToRace {
  READY
  RACING
  DROPPED
}

model Driver {
  id            String    @id @default(cuid())
  firstname     String
  lastname      String
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  username      String    @unique
  password      String

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt()
  driverSessions   DriverSession[]
  presences        Presence[]
  raceParticipants RaceParticipant[]
  telemetryWindows TelemetryWindow[]
  raceScores       RaceScore[]
  raceResults      RaceResult[]

  @@index([id, username])
}

model DriverSession {
  id       String   @id @default(cuid())
  driver   Driver   @relation(fields: [driverId], references: [id])
  lastSeen DateTime
  isActive Boolean

  driverId String
}

model Presence {
  id       String @id @default(cuid())
  driver   Driver @relation(fields: [driverId], references: [id])
  driverId String
  lat      BigInt
  lon      BigInt
  heading  BigInt

  speedBucket SpeedBucket
  updatedAt   DateTime    @updatedAt()
}

model Route {
  id String @id @default(cuid())

  // polyline { lat: number; lon: number }[]
  routeSegments RouteSegment[]
  races         Race[]
}

model RouteSegment {
  id    String @id @default(cuid())
  route Route  @relation(fields: [routeId], references: [id])

  routeId String
  index   Int
  start   Json
  end     Json

  races            Race[]
  telemetryWindows TelemetryWindow[]
}

model Race {
  id String @id @default(cuid())

  route            Route             @relation(fields: [routeId], references: [id])
  routeId          String
  segment          RouteSegment      @relation(fields: [routeSegmentId], references: [id])
  state            RaceState
  startAt          DateTime
  durationSec      Int
  createdAt        DateTime
  routeSegmentId   String
  raceParticipants RaceParticipant[]
  telemetryWindows TelemetryWindow[]
  raceScores       RaceScore[]
  raceResults      RaceResult[]
}

model RaceParticipant {
  id String @id @default(cuid())

  raceId   String
  driverId String

  driver Driver @relation(fields: [driverId], references: [id])
  race   Race   @relation(fields: [raceId], references: [id])

  joinedAt DateTime    @default(now())
  status   ReadyToRace

  @@unique([raceId, driverId])
}

model TelemetryWindow {
  id String @id @default(cuid())

  race        Race         @relation(fields: [raceId], references: [id])
  driver      Driver       @relation(fields: [driverId], references: [id])
  segment     RouteSegment @relation(fields: [routeSegmentId], references: [id])
  windowStart DateTime
  windowEnd   DateTime
  avgSpeed    Int
  distance    Int

  raceId         String
  driverId       String
  routeSegmentId String

  @@unique([raceId, driverId])
}

model RaceScore {
  id String @id @default(cuid())

  race          Race   @relation(fields: [raceId], references: [id])
  driver        Driver @relation(fields: [driverId], references: [id])
  totalDistance Int
  lastDelta     Int

  raceId   String
  driverId String
}

model RaceResult {
  id String @id @default(cuid())

  race         Race     @relation(fields: [raceId], references: [id])
  winnerDriver Driver   @relation(fields: [driverId], references: [id])
  finalDelta   Int
  finishedAt   DateTime
  raceId       String
  driverId     String
}
